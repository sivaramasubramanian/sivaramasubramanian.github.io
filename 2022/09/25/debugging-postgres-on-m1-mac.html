<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Build and Debug Postgres using VS Code on a Mac | Sivaram’s Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Build and Debug Postgres using VS Code on a Mac" />
<meta name="author" content="Sivarama Subramanian" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post explains how to build Postgres from Source code and debug it using VS Code." />
<meta property="og:description" content="This post explains how to build Postgres from Source code and debug it using VS Code." />
<link rel="canonical" href="https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html" />
<meta property="og:url" content="https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html" />
<meta property="og:site_name" content="Sivaram’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-25T05:15:01+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Build and Debug Postgres using VS Code on a Mac" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sivarama Subramanian"},"dateModified":"2022-09-25T05:15:01+00:00","datePublished":"2022-09-25T05:15:01+00:00","description":"This post explains how to build Postgres from Source code and debug it using VS Code.","headline":"Build and Debug Postgres using VS Code on a Mac","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html"},"url":"https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.sivaram.co.in/feed.xml" title="Sivaram&apos;s Blog" /><script async defer src="https://www.googletagmanager.com/gtag/js?id=G-4P2CXDSEJN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4P2CXDSEJN');
</script>


<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png?v=2">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=2">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=2">
<link rel="manifest" href="/site.webmanifest?v=2">
<link rel="mask-icon" href="/safari-pinned-tab.svg?v=2" color="#5bbad5">
<link rel="shortcut icon" href="/favicon.ico?v=2">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Sivaram&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tools/">Tools</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Build and Debug Postgres using VS Code on a Mac</h1>
    <p class="post-meta"><time class="dt-published" datetime="2022-09-25T05:15:01+00:00" itemprop="datePublished">
        Sep 25, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In this post, we will see how to build Postgres from the source code and debug it to trace through a simple
query execution using <a href="https://code.visualstudio.com/">Visual Studio Code</a> in a M1 Mac.
<!--more--></p>
<h3 id="dependencies">Dependencies</h3>
<p>Before starting make sure all the <a href="https://www.postgresql.org/docs/14/install-requirements.html">dependencies</a> are installed.
We will need,</p>
<ol>
  <li>Git</li>
  <li>GCC compiler</li>
  <li>make</li>
  <li>VS Code</li>
</ol>

<h3 id="build-and-install-postgres">Build and Install Postgres</h3>
<ol>
  <li>First we have to get the source code, we can clone the official Git repo,
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://git.postgresql.org/git/postgresql.git
</code></pre></div>    </div>
    <p>There is also a <a href="https://github.com/postgres/postgres">mirror</a> of the repository in Github. We can use any one of these, it would be fine.</p>
  </li>
  <li>After cloning the repo, cd into the folder ‘postgresql’. We can either build from the master branch or a release-specific branch.
For example, to build Postgres 14, we have to switch to ‘REL_14_STABLE’ branch.
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout REL_14_STABLE <span class="o">&amp;&amp;</span> git pull
</code></pre></div>    </div>
  </li>
  <li>To configure the build, run the following command,
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure <span class="nt">--prefix</span><span class="o">=</span><span class="nv">$HOME</span>/postgres/pg14 <span class="nt">--enable-cassert</span> <span class="se">\</span>
<span class="nt">--enable-debug</span>  <span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">"-ggdb -O0 -fno-omit-frame-pointer"</span> <span class="nv">CPPFLAGS</span><span class="o">=</span><span class="s2">"-g -O0"</span>
</code></pre></div>    </div>
    <ul>
      <li>prefix - folder where Postgres will be installed</li>
      <li>enable-cassert - Enable C Assert statements</li>
      <li>enable-debug - Enable Debug mode in build</li>
      <li>CFLAGS - C compiler flags
        <ul>
          <li>-O0 - disable optimisation</li>
          <li>-g - generate debug symbols</li>
        </ul>
      </li>
      <li>CPPFLAGS - C++ compiler flags
I have given postgres/pg14 folder under my HOME directory as installation location for this Postgres build.</li>
    </ul>
  </li>
  <li>‘configure’ script will do a few checks and configure the build, the output should end with something like
    <blockquote>
      <p>config.status: linking src/include/port/darwin.h to src/include/pg_config_os.h
config.status: linking src/makefiles/Makefile.darwin to src/Makefile.port</p>
    </blockquote>
  </li>
  <li>
    <p>‘configure’ would have created a ‘Makefile.global’ under ‘src’ directory, we need to check and make sure optimisations are disable, debug symbols are enabled in the build.
Open <code class="language-plaintext highlighter-rouge">src/Makefile.global</code> file and check CFLAGS and CPPFLAGS variables to see if they have <code class="language-plaintext highlighter-rouge">-g</code> and <code class="language-plaintext highlighter-rouge">-O0</code> flags.</p>
  </li>
  <li>
    <p>Run <code class="language-plaintext highlighter-rouge">make &amp;&amp; make install</code> to run the build and install the outputs to installation directory (<code class="language-plaintext highlighter-rouge">$HOME/postgres/pg14</code>)</p>
  </li>
  <li>After <code class="language-plaintext highlighter-rouge">make &amp;&amp; make install</code> succeeds, go to installation directory and check if the build has debug symbols
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> <span class="nv">$HOME</span>/postgres/pg14/bin
nm <span class="nt">-pa</span> ./postgres | <span class="nb">grep </span>OSO
</code></pre></div>    </div>
    <p><code class="language-plaintext highlighter-rouge">nm</code> is used to list the symbol table names in a binary. For PG14, nm returned around 747 entires.
If you do not find any symbol table entries, or the entries are low, make sure you disabled optimisation in Makefile. If you missed it, add <code class="language-plaintext highlighter-rouge">-O0</code> in Makefile.global, run <code class="language-plaintext highlighter-rouge">make clean</code> and then repeat <code class="language-plaintext highlighter-rouge">make &amp;&amp; make install</code></p>
  </li>
  <li>Initialize a PGDATA folder for the database using <code class="language-plaintext highlighter-rouge">initdb</code>, I’m using <code class="language-plaintext highlighter-rouge">$HOME/postgres/pgdata</code> as my data directory,
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$HOME</span>/postgres/pg14/bin/initdb <span class="nt">-D</span> <span class="nv">$HOME</span>/postgres/pgdata
</code></pre></div>    </div>
    <p>You should an output similar to this,</p>
    <blockquote>
      <p>Success. You can now start the database server using:</p>

      <p>/Users/me/postgres/pg14/bin/pg_ctl -D /Users/me/postgres/pgdata -l logfile start</p>
    </blockquote>
  </li>
  <li>(Optional) You can now edit and customize the <code class="language-plaintext highlighter-rouge">postgresql.conf</code> file.
I usually change the postgres port to 5433 so that I can keep running a normal non-debug database at 5432 for other purposes.
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>code <span class="nv">$HOME</span>/postgres/pgdata/postgresql.conf
</code></pre></div>    </div>
  </li>
  <li>Now we can start the Database,
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$HOME</span>/postgres/pg14/bin/pg_ctl <span class="nt">-D</span> <span class="nv">$HOME</span>/postgres/pgdata <span class="nt">-l</span> logfile start
</code></pre></div>    </div>
    <p>We should see this output,</p>
    <blockquote>
      <p>waiting for server to start…. done <br />
server started</p>
    </blockquote>
  </li>
  <li>We can create a db and login run a simple query.
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$HOME</span>/postgres/pg14/bin/createdb <span class="nt">-p</span> 5433 sample
<span class="nv">$HOME</span>/postgres/pg14/bin/psql <span class="nt">-p</span> 5433 sample
</code></pre></div>    </div>
    <p>We should be logged into the psql console now, we can try to create a sample table an run some queries.</p>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">hello</span><span class="p">(</span><span class="n">id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message</span> <span class="nb">text</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">hello</span> <span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Hello world!'</span><span class="p">);</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">hello</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="debug-postgres-in-vs-code">Debug Postgres in VS Code</h3>
<p>Now that we have a running postgres server, lets start debugging it.</p>
<ol>
  <li>
    <p>Open the Postgres source code in VS code and create a <a href="https://code.visualstudio.com/docs/editor/debugging#_launch-configurations">launch.json</a> file.</p>
  </li>
  <li>Add launch configuration to attach to the postgres process, for example
    <div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="c1">// Use IntelliSense to learn about possible attributes.</span><span class="w">
 </span><span class="c1">// Hover to view descriptions of existing attributes.</span><span class="w">
 </span><span class="c1">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><span class="w">
 </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
     </span><span class="p">{</span><span class="w">
         </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(lldb) Attach DB"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cppdbg"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"attach"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${env:HOME}/postgres/pg14/bin/postgres"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"MIMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lldb"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"targetArchitecture"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arm64"</span><span class="w">
     </span><span class="p">},</span><span class="w">
 </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
    <p>Make sure the <code class="language-plaintext highlighter-rouge">targetArchitecture</code> is set to arm64 for M1 macs. <code class="language-plaintext highlighter-rouge">program</code> must point to the <code class="language-plaintext highlighter-rouge">postgres</code> binary under <code class="language-plaintext highlighter-rouge">bin/</code> in our installation directory.</p>
  </li>
  <li>Now login to the database via psql in a terminal and find the postgres backend Process ID. Keep this terminal open for later use,
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$HOME</span>/postgres/pg14/bin/psql <span class="nt">-p</span> 5433 sample
</code></pre></div>    </div>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">pg_backend_pid</span><span class="p">();</span>
</code></pre></div>    </div>
    <p><a href="https://www.postgresql.org/docs/9.4/functions-info.html">pg_backend_pid()</a> is a system function that returns the process id of the postgres backend for the current session.</p>
    <blockquote>
      <p>pg_backend_pid <br />
—————-<br />
         11340<br />
(1 row)</p>
    </blockquote>
  </li>
  <li>
    <p>Create a breakpoint in any function, I use <code class="language-plaintext highlighter-rouge">exec_simple_query</code> in <code class="language-plaintext highlighter-rouge">src/backend/tcop/postgres.c</code> this is where the query execution starts.</p>
  </li>
  <li>
    <p>Now, Start Debugging (Press <code class="language-plaintext highlighter-rouge">F5</code> or <code class="language-plaintext highlighter-rouge">Run and Debug</code> -&gt; <code class="language-plaintext highlighter-rouge">(lldb) Attach DB</code>), it will ask for a pid, paste the pg_backend_pid that we got from the psql terminal.</p>
  </li>
  <li>Once debugger is ready, go back to the same <code class="language-plaintext highlighter-rouge">psql</code> terminal and run a SQL query, like
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">hello</span><span class="p">;</span>
</code></pre></div>    </div>
    <p>The VS code breakpoint will get triggered now, from here you can view the variables and do normal step debugging</p>
  </li>
</ol>

<!-- {:refdef: style="text-align: center;"} -->

<p><img src="/assets/resized/1400/vs-code-pg-debugging.webp" alt="Debugging PG in VS Code" title="Debugging PG in VS Code" srcset="    /assets/resized/480/vs-code-pg-debugging.webp 480w,    /assets/resized/800/vs-code-pg-debugging.webp 800w,    /assets/resized/1400/vs-code-pg-debugging.webp 1400w, /assets/vs-code-pg-debugging.webp 2928w" />
<!-- {: refdef} --></p>

<p>Thats it we can trace the flow of query execution within Postgres.
Let me know in the comments if you face any issue.</p>

<p>In the next post, we will see the various stages of query execution in postgres and its internal workings.</p>

<h3 id="references">References</h3>
<ol>
  <li><a href="https://www.postgresql.org/docs/14/install-procedure.html">https://www.postgresql.org/docs/14/install-procedure.html</a></li>
  <li><a href="https://www.postgresql.org/docs/14/functions-info.html#id-1.5.8.32.4.2.2.11.1.1.1">https://www.postgresql.org/docs/14/functions-info.html</a></li>
</ol>

  </div>
  <div class="post-tags">
    
    
    <a href="/tags/#tag_postgres">#postgres</a>
    &nbsp;
    
    <a href="/tags/#tag_how-to">#how-to</a>
    
    
  </div>

  <hr><div class="share-page">
    Share this on
    <ul class="social-media-list">

        <li><a rel="me"
                href="https://twitter.com/intent/tweet?text=Build and Debug Postgres using VS Code on a Mac&url=https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html&via=&related="
                rel="nofollow" target="_blank"><svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
                </svg></a></li>

        <li><a rel="me" href="https://facebook.com/sharer.php?u=https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html" rel="nofollow"
                target="_blank"><svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#facebook"></use>
                </svg></a></li>


        <li><a rel="me"
                href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html&title=Build and Debug Postgres using VS Code on a Mac&summary=This post explains how to build Postgres from Source code and debug it using VS Code.&source=https://blog.sivaram.co.in"
                rel="nofollow" target="_blank"><svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
                </svg></a></li>


        <li><a rel="me" href="https://www.reddit.com/submit?title=Build and Debug Postgres using VS Code on a Mac&url=https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html"
                rel="nofollow" target="_blank">
                <svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#reddit"></use>
                </svg>
            </a>
        </li>

    </ul>
</div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html';
      this.page.identifier = 'https://blog.sivaram.co.in/2022/09/25/debugging-postgres-on-m1-mac.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://sivaram-blog.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2022/09/25/debugging-postgres-on-m1-mac.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/"></data>
  
    <div class="wrapper">
  
      <div class="footer-col-wrapper">
        <div class="footer-col">
          <p class="feed-subscribe">
            <a href="/feed.xml">
              <svg class="svg-icon orange">
                <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
              </svg><span>Subscribe</span>
            </a>
          </p>
          <ul class="contact-list">
            <li class="p-name">Sivarama Subramanian</li>
            <li><a class="u-email" href="mailto:sivaraam1024+ghblog@gmail.com">sivaraam1024@gmail.com</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <p>Blogging about programming, databases, performance optimization, and other stuff
</p>
        </div>
      </div>
  
      <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sivaramasubramanian" target="_blank" title="sivaramasubramanian"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/sivarama-subramanian" target="_blank" title="sivarama-subramanian"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/sivaraam07" target="_blank" title="sivaraam07"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>
  
    </div>
  
  </footer></body>

</html>
