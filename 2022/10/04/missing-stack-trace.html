<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>The curious case of missing stack traces | Sivaram’s Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="The curious case of missing stack traces" />
<meta name="author" content="Sivarama Subramanian" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post explains how to build Postgres from Source code and debug it using VS Code." />
<meta property="og:description" content="This post explains how to build Postgres from Source code and debug it using VS Code." />
<link rel="canonical" href="https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html" />
<meta property="og:url" content="https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html" />
<meta property="og:site_name" content="Sivaram’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-04T05:15:01+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The curious case of missing stack traces" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sivarama Subramanian"},"dateModified":"2022-10-04T05:15:01+00:00","datePublished":"2022-10-04T05:15:01+00:00","description":"This post explains how to build Postgres from Source code and debug it using VS Code.","headline":"The curious case of missing stack traces","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html"},"url":"https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.sivaram.co.in/feed.xml" title="Sivaram&apos;s Blog" /><script async defer src="https://www.googletagmanager.com/gtag/js?id=G-4P2CXDSEJN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4P2CXDSEJN');
</script>


<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png?v=2">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=2">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=2">
<link rel="manifest" href="/site.webmanifest?v=2">
<link rel="mask-icon" href="/safari-pinned-tab.svg?v=2" color="#5bbad5">
<link rel="shortcut icon" href="/favicon.ico?v=2">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Sivaram&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">The curious case of missing stack traces</h1>
    <p class="post-meta"><time class="dt-published" datetime="2022-10-04T05:15:01+00:00" itemprop="datePublished">
        Oct 4, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In this post, we will see about a weird issue that I came across with missing Java stack traces, how I overcame it, and the learnings from it.
<!--more--></p>
<h3 id="the-issue">The issue</h3>
<p>A few days back, a co-worker came to me with a strange issue; While debugging an issue using logs, he came across a few logs where Exceptions were printed but there was no stack trace.</p>

<p>So to be clear, the exception messages were there but the stack traces with the call tree, file name, line number, etc were all missing.</p>

<h3 id="debugging">Debugging</h3>
<p>At first, I thought it must be a cause of erroneous logging, Log4j has many overloaded methods to log messages and it is easy to miss the correct method to log exceptions with the stack trace.</p>

<p>But in this case, we checked the code and it was using the <a href="https://logging.apache.org/log4j/2.x/log4j-api/apidocs/org/apache/logging/log4j/Logger.html#info-org.apache.logging.log4j.Marker-java.lang.Object-java.lang.Throwable-">correct method</a> and passing the exception object as a parameter.</p>

<p>Then I vaguely remembered reading about something similar in a <a href="https://www.javaspecialists.eu/archive/">Java Specialists</a> Newsletter. After a quick Google search, we found this <a href="https://www.javaspecialists.eu/archive/Issue187-Cost-of-Causing-Exceptions.html">article</a> that speaks about this behavior.</p>

<p>To quote from the article,</p>
<blockquote>
  <p>After a relatively short while, it began returning the same exception instance, with an empty stack trace. You might have seen empty stack traces in your logs. <strong>This is why they occur. Too many exceptions are happening too closely together and eventually the server HotSpot compiler optimizes the code</strong> to deliver a single instance back to the user.</p>
</blockquote>

<h3 id="the-fix">The fix</h3>
<p>Hotspot VM removes the stack trace for performance optimization when too many exceptions occur in a short period. Now that we know this, we need to find a way to get the original trace.</p>

<p>As per JDK 5 <a href="https://www.oracle.com/java/technologies/javase/release-notes-introduction.html#vm">release notes</a>, We can pass the flag <code class="language-plaintext highlighter-rouge">-XX:-OmitStackTraceInFastThrow</code> to the JVM to disable this optimization, but we didn’t have the choice of changing the flag and restarting the JVM.</p>

<p>JVM prints the trace for the first few exceptions, the optimization kicks in only when the exceptions are frequent, so we filtered the logs for the particular machine and sorted the exception logs from old to new, and there it was! the complete trace with the call tree and source line info etc.</p>

<h3 id="learnings">Learnings</h3>
<p>The issue was fixed, but I became curious about why this optimization was done by Hotspot and how it was done.
Going back to that article from JavaSpecialists Newsletter, we can understand that creating Throwable objects and filling them with stack traces is expensive, especially when these exceptions occur at a high rate.</p>

<p>So Hotspot bypasses this expensive operation and returns a preallocated Exception object for all the calls, but this optimization is only applicable for ‘known’ exceptions like <code class="language-plaintext highlighter-rouge">NullPointerException</code>, <code class="language-plaintext highlighter-rouge">ArrayIndexOutOfBoundsException</code>, etc.</p>

<p>If we need to optimize the object creation for custom Exceptions, we have to override <a href="https://docs.oracle.com/en/java/javase/19/docs/api/java.base/java/lang/Throwable.html#fillInStackTrace()">fillInStackTrace()</a> method in Throwable class. This method looks at the thread’s stack trace and fills it in the exception object. Since this might be expensive, for cases where we don’t need stack traces we can override this method and set stack trace to be empty.</p>

<p>Norman Maurer, one of the developers of Netty, has written a blog post analyzing the performance improvement of removing the stack trace - <a href="http://normanmaurer.me/blog/2013/11/09/The-hidden-performance-costs-of-instantiating-Throwables/" data-proofer-ignore="true">The hidden cost of instantiating throwables</a></p>

<p>Even though there are performance benefits to skipping the stack trace when instantiating Exceptions, we must keep in mind that Exceptions are for indicating an error or exceptional occurrence and should not be used for control flow. As such Exceptions may not be as useful without stack traces.</p>

<h3 id="references">References</h3>
<ol>
  <li><a href="https://www.javaspecialists.eu/archive/Issue187-Cost-of-Causing-Exceptions.html">Cost of Causing Exceptions - JavaSpecialists</a></li>
  <li><a href="http://normanmaurer.me/blog/2013/11/09/The-hidden-performance-costs-of-instantiating-Throwables/" data-proofer-ignore="true">The hidden cost of instantiating throwables - Norman Maurer’s Blog</a></li>
  <li><a href="https://www.javaspecialists.eu/archive/Issue129-Fast-Exceptions-in-RIFE.html">Fast Exceptions in RIFE - JavaSpecialists</a></li>
</ol>

  </div>
  <div class="post-tags">
    
    
    <a href="/tags/#tag_java">#java</a>
    
    
  </div>

  <hr><div class="share-page">
    Share this on
    <ul class="social-media-list">

        <li><a rel="me"
                href="https://twitter.com/intent/tweet?text=The curious case of missing stack traces&url=https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html&via=&related="
                rel="nofollow" target="_blank"><svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
                </svg></a></li>

        <li><a rel="me" href="https://facebook.com/sharer.php?u=https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html" rel="nofollow"
                target="_blank"><svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#facebook"></use>
                </svg></a></li>


        <li><a rel="me"
                href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html&title=The curious case of missing stack traces&summary=This post explains how to build Postgres from Source code and debug it using VS Code.&source=https://blog.sivaram.co.in"
                rel="nofollow" target="_blank"><svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
                </svg></a></li>


        <li><a rel="me" href="https://www.reddit.com/submit?title=The curious case of missing stack traces&url=https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html"
                rel="nofollow" target="_blank">
                <svg class="svg-icon grey">
                    <use xlink:href="/assets/minima-social-icons.svg#reddit"></use>
                </svg>
            </a>
        </li>

    </ul>
</div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html';
      this.page.identifier = 'https://blog.sivaram.co.in/2022/10/04/missing-stack-trace.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://sivaram-blog.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2022/10/04/missing-stack-trace.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/"></data>
  
    <div class="wrapper">
  
      <div class="footer-col-wrapper">
        <div class="footer-col">
          <p class="feed-subscribe">
            <a href="/feed.xml">
              <svg class="svg-icon orange">
                <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
              </svg><span>Subscribe</span>
            </a>
          </p>
          <ul class="contact-list">
            <li class="p-name">Sivarama Subramanian</li>
            <li><a class="u-email" href="mailto:sivaraam1024+ghblog@gmail.com">sivaraam1024@gmail.com</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <p>Blogging about programming, databases, performance optimization, and other stuff
</p>
        </div>
      </div>
  
      <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sivaramasubramanian" target="_blank" title="sivaramasubramanian"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/sivarama-subramanian" target="_blank" title="sivarama-subramanian"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/sivaraam07" target="_blank" title="sivaraam07"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>
  
    </div>
  
  </footer></body>

</html>
